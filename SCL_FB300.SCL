(* ====================================================================== *)
(* FB300: EINRICHTBETRIEB (HANDBETRIEB)                                   *)
(* ====================================================================== *)

FUNCTION_BLOCK FB300 // Einrichtbetrieb (Handbetrieb)

VAR_INPUT
  Einrichtbetrieb : BOOL; // Eingang: TRUE, wenn Einrichtbetrieb gewaehlt ist.
END_VAR

VAR
  // Timer_QA61 : TON; // Timer T1 (TON) fuer Magnet-Schuetz -obsolet nach Umruestung
END_VAR

BEGIN // Start der FB300-Logik

  // --- 0. SCHUTZBEDINGUNG (Guard Clause) ---
  IF Einrichtbetrieb THEN // Tippbetrieb nur aktiv, wenn Einrichtbetrieb angewÃ¤hlt ist

    // --- HANDBETRIEB AKTIV ---

    // -- Steuerung X-Achse (SR-Logik mit Vorrang Reset) --
    IF ("-SJ6" AND NOT "-SJ7" AND NOT "-BG11" AND NOT sig_QA6) THEN
      sig_QA5 := TRUE;
    ELSIF "-BG11" OR ("-SJ7" AND NOT "-SJ6") THEN
      sig_QA5 := FALSE;
    END_IF;

    IF ("-SJ7" AND NOT "-SJ6" AND NOT "-BG13" AND NOT sig_QA5) THEN
      sig_QA6 := TRUE;
    ELSIF "-BG13" OR ("-SJ6" AND NOT "-SJ7") THEN
      sig_QA6 := FALSE;
    END_IF;

    // -- Steuerung Zylinder MM20 (Magazin) (SR-Logik) --
    IF ("-SJ8" AND NOT "-SJ9" AND NOT "-BG21") THEN // Einfahren
      sig_MB21 := TRUE;
    ELSIF "-BG21" OR ("-SJ9" AND NOT "-SJ8") THEN
      sig_MB21 := FALSE;
    END_IF;

    IF ("-SJ9" AND NOT "-SJ8" AND NOT "-BG22") THEN // Ausfahren
      sig_MB22 := TRUE;
    ELSIF "-BG22" OR ("-SJ8" AND NOT "-SJ9") THEN
      sig_MB22 := FALSE;
    END_IF;

    // -- Steuerung Zylinder MM30 (Wippe) (Selbsthaltung) --
    IF (NOT "-SJ10") THEN // Taster nach unten -> Einfahren
      sig_MB31 := TRUE;
    ELSIF "-BG31" THEN // Endlage erreicht -> Ruecksetzen
      sig_MB31 := FALSE;
    END_IF;

    IF ("-SJ10" AND NOT "-BG32") THEN // Taster nach oben -> Ausfahren
      sig_MB32 := TRUE;
    ELSIF "-BG32" OR (NOT "-SJ10") THEN // Endlage ODER Taster losgelassen
      sig_MB32 := FALSE;
    END_IF;

    // -- Steuerung Zylinder MM40 (Magnet) -- -obsolet nach Umruestung
    // IF ("-SJ11" AND NOT "-SJ12" AND NOT "-BG41") THEN // Einfahren
    //   sig_MB41 := TRUE;
    // ELSIF "-BG41" OR ("-SJ12" AND NOT "-SJ11") THEN
    //   sig_MB41 := FALSE;
    // END_IF;
    //
    // IF ("-SJ12" AND NOT "-SJ11" AND NOT "-BG42") THEN // Ausfahren
    //   sig_MB42 := TRUE;
    // ELSIF "-BG42" OR ("-SJ11" AND NOT "-SJ12") THEN
    //   sig_MB42 := FALSE;
    // END_IF;

    // -- Steuerung Magnet-Schuetz QA61 -- -obsolet nach Umruestung
    // IF ("-SJ12" AND NOT "-SJ11") THEN // Taster "Magnet EIN"
    //   sig_QA61 := TRUE;
    // ELSIF ("-SJ11" AND NOT "-SJ12") THEN // Taster "Magnet AUS"
    //   sig_QA61 := FALSE;
    // END_IF;
    //
    // // Timer-Aufruf
    // Timer_QA61(IN := sig_QA61, PT := T#3s);


  ELSE // --- HANDBETRIEB NICHT AKTIV ---

    // Alle Signale auf FALSE setzen, wenn Einrichtbetrieb verlassen wird
    sig_QA5  := FALSE;
    sig_MB22 := FALSE;
    sig_MB21 := FALSE;
    sig_MB31 := FALSE;
    sig_MB32 := FALSE;
    // sig_MB41 := FALSE; -obsolet nach Umruestung
    // sig_MB42 := FALSE; -obsolet nach Umruestung
    // sig_QA61 := FALSE; -obsolet nach Umruestung
    sig_QA6  := FALSE;

    // Timer_QA61(IN := FALSE); -obsolet nach Umruestung

    RETURN; // Bearbeitung beenden
  END_IF;

END_FUNCTION_BLOCK